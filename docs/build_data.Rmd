---
title: "Build Data Set"
author: "Christopher Prener, Ph.D."
date: '(`r format(Sys.time(), "%B %d, %Y")`)'
output: 
  github_document: default
  html_notebook: default 
---

## Introduction
This notebook builds the analytical data set from the results of `redlining_area.Rmd`, CDC data, and demographic data.

## Dependencies
This notebook requires a number of packages:

```{r load-packages}
# tidyverse packages
library(dplyr)         # data wrangling
library(readr)

# other packages
library(cityHealth)    # CDC data
library(here)          # file path management
library(sf)            # spatial tools
library(tidycensus)    # demographic data
library(tidyseg)       # tidy segregation tools
```

## Load Data
This notebook requires the redlining data already calculated for St. Louis:

```{r load-data}
redlining <- read_csv(here("data", "redlining", "STL_REDLINING_cdGrade.csv"))
redlining <- mutate(redlining, GEOID = as.character(GEOID))
```

## Demographic Data

The first goal of this notebook is to download and prepare for joining all of the needed demographic data.

### Race
*individuals*
```{r}
race <- get_acs(geography = "tract", table = "B02001", state = 29, county = 510, 
                     year = 2016, output = "wide")

race %>%
  rename(totalPop = B02001_001E) %>%
  rename(totalPop_m = B02001_001M) %>%
  rename(white = B02001_002E) %>%
  rename(white_m = B02001_002M) %>%
  rename(black = B02001_003E) %>%
  rename(black_m = B02001_003M) %>%
  mutate(otherRace = totalPop-white-black) %>%
  select(GEOID, totalPop, totalPop_m, white, white_m, black, black_m, otherRace) -> race
```

### Median Income
*household*
```{r}
medianInc <- get_acs(geography = "tract", variables = "B19019_001", state = 29, county = 510, 
                     year = 2016, output = "wide")

medianInc %>%
  select(-NAME) %>%
  rename(medianInc = B19019_001E) %>%
  rename(medianInc_m = B19019_001M) -> medianInc
```

### Poverty Status
*individuals*
```{r}
poverty <- get_acs(geography = "tract", variables = "B17001_002", state = 29, county = 510, 
                     year = 2016, output = "wide")

poverty %>%
  select(-NAME) %>%
  rename(poverty = B17001_002E) %>%
  rename(poverty_m = B17001_002M) -> poverty
```

*individuals*
```{r}
povertyB <- get_acs(geography = "tract", variables = "B17001B_002", state = 29, county = 510, 
                     year = 2016, output = "wide")

povertyB %>%
  select(-NAME) %>%
  rename(povertyB = B17001B_002E) %>%
  rename(povertyB_m = B17001B_002M) -> povertyB
```

*individuals*


```{r}
medicaid <- get_acs(geography = "tract", table = "C27007", state = 29, county = 510, 
                     year = 2016, output = "wide")

medicaid %>%
  mutate(medicaid = C27007_004E + C27007_007E + C27007_010E + C27007_014E + C27007_017E + C27007_020E) %>%
  select(GEOID, medicaid) -> medicaid
```


*households*


```{r}
tanf <- get_acs(geography = "tract", table = "B19057", state = 29, county = 510, 
                     year = 2016, output = "wide")

tanf %>%
  rename(house = B19057_001E) %>%
  rename(house_m = B19057_001M) %>%
  rename(tanf = B19057_002E) %>%
  rename(tanf_m = B19057_002M) %>%
  mutate(tanfProp = tanf/house) %>%
  select(GEOID, house, house_m, tanf, tanf_m, tanfProp) -> tanf
```

*households* 
```{r}
snap <- get_acs(geography = "tract", table = "B19058", state = 29, county = 510, 
                     year = 2016, output = "wide")

snap %>%
  rename(snap = B19058_002E) %>%
  rename(snap_m = B19058_002M) %>%
  mutate(snapProp = snap/B19058_001E) %>%
  select(GEOID, snap, snap_m, snapProp) -> snap
```

*households*
 
```{r}
tenure <- get_acs(geography = "tract", table = "B25003", state = 29, county = 510, 
                     year = 2016, output = "wide")

tenure %>%
  rename(own = B25003_002E) %>%
  rename(own_m = B25003_002M) %>%
  mutate(ownProp = own/B25003_001E) %>%
  rename(rent = B25003_003E) %>%
  rename(rent_m = B25003_003M) %>%
  mutate(rentProp = rent/B25003_001E) %>%
  select(GEOID, own, own_m, ownProp, rent, rent_m, rentProp) -> tenure
```


```{r}
write_csv(medianInc, here("data", "medianInc.csv"))
write_csv(medicaid, here("data", "medicaid.csv"))
write_csv(poverty, here("data", "poverty.csv"))
write_csv(povertyB, here("data", "povertyB.csv"))
write_csv(race, here("data", "race.csv"))
write_csv(snap, here("data", "snap.csv"))
write_csv(tanf, here("data", "tanf.csv"))
```


## CDC Data

```{r}
# subset data for City of St. Louis and trim number of columns
ch_tbl_tract17 %>%
  filter(city_fips == 2965000) %>%
  select(tract_fips, category, question, estimate, estimate_ci_low, estimate_ci_high) %>%
  rename(GEOID = tract_fips) -> cdc_stl
```

```{r}
cdc_stl %>%
  filter(question == "Current Asthma") %>%
  select(GEOID, estimate, estimate_ci_low, estimate_ci_high) %>% 
  rename(asthma = estimate) %>%
  rename(asthma_ml = estimate_ci_low) %>%
  rename(asthma_mh = estimate_ci_high) -> asthma
```

```{r}
cdc_stl %>%
  filter(question == "Obesity") %>%
  select(GEOID, estimate, estimate_ci_low, estimate_ci_high) %>% 
  rename(obesity = estimate) %>%
  rename(obesity_ml = estimate_ci_low) %>%
  rename(obesity_mh = estimate_ci_high) -> obesity
```

```{r}
cdc_stl %>%
  filter(question == "Dental Visit") %>%
  select(GEOID, estimate, estimate_ci_low, estimate_ci_high) %>% 
  rename(dental = estimate) %>%
  rename(dental_ml = estimate_ci_low) %>%
  rename(dental_mh = estimate_ci_high) -> dental
```

```{r}
cdc_stl %>%
  filter(question == "Health Insurance") %>%
  select(GEOID, estimate, estimate_ci_low, estimate_ci_high) %>% 
  rename(unins = estimate) %>%
  rename(unins_ml = estimate_ci_low) %>%
  rename(unins_mh = estimate_ci_high) -> unins
```


## Combine Data

```{r}
analysis <- left_join(redlining, race, by = "GEOID")

analysis %>%
  left_join(y = medianInc, by = "GEOID") %>%
  left_join(y = poverty, by = "GEOID") %>%
  left_join(y = povertyB, by = "GEOID") %>%
  left_join(y = medicaid, by = "GEOID") %>%
  left_join(y = tanf, by = "GEOID") %>%
  left_join(y = snap, by = "GEOID") %>%
  left_join(y = tenure, by = "GEOID") %>%
  left_join(y = unins, by = "GEOID") %>%
  left_join(y = asthma, by = "GEOID") %>%
  left_join(y = obesity, by = "GEOID") %>%
  left_join(y = dental, by = "GEOID") -> analysis

analysis %>%
  mutate(whiteProp = white/totalPop) %>%
  mutate(blackProp = black/totalPop) %>%
  mutate(otherRaceProp = otherRace/totalPop) %>%
  mutate(povertyProp = poverty/totalPop) %>%
  mutate(povertyBProp = povertyB/totalPop) %>%
  mutate(medicaidProp = medicaid/totalPop) %>%
  mutate(uninsProp = unins/100) %>%
  mutate(asthmaProp = asthma/100) %>%
  mutate(obesityProp = obesity/100) %>%
  mutate(dentalProp = dental/100) -> analysis



```

```{r}
analysis <- ts_dissim(analysis, popA = white, popB = black, dissim = dissim, return = "tibble")

```



```{r}
analysis <- select(analysis, GEOID, ALAND, cGrade, dGrade, cdGrade, 
                   totalPop, totalPop_m, house, house_m,
                   white, white_m, whiteProp, black, black_m, blackProp, otherRace, otherRaceProp,
                   dissim,
                   medianInc, medianInc_m,
                   poverty, poverty_m, povertyProp, 
                   povertyB, povertyB_m, povertyBProp, 
                   medicaid, medicaidProp, 
                   tanf, tanf_m, tanfProp, 
                   snap, snap_m, snapProp, 
                   own, own_m, ownProp, rent, rent_m, rentProp, 
                   unins, unins_ml, unins_mh, uninsProp, 
                   asthma, asthma_ml, asthma_mh, asthmaProp, 
                   obesity, obesity_ml, obesity_mh, obesityProp,
                   dental, dental_ml, dental_mh, dentalProp)

write_csv(analysis, path = here("data", "analysis", "analysis_full.csv"))
```



```{r}
analysisSlim <- select(analysis, GEOID, cdGrade, whiteProp, blackProp, otherRaceProp, dissim, medianInc, 
                       povertyProp, povertyBProp, medicaidProp, tanfProp, snapProp, rentProp, 
                       uninsProp, asthmaProp, obesityProp, dentalProp)

write_csv(analysisSlim, path = here("data", "analysis", "analysis_slim.csv"))
```


```{r}
tracts <- st_read(here("data", "spatial", "raw", "STL_DEMOGRAPHICS_Tracts.shp"), stringsAsFactors = FALSE)
```

```{r}
analysisSlim %>%
  rename(CDGRADE = cdGrade) %>%
  rename(WHITE = whiteProp) %>%
  rename(BLACK = blackProp) %>%
  rename(OTHERRACE = otherRaceProp) %>%
  rename(DISSIM = dissim) %>%
  rename(MEDINC = medianInc) %>%
  rename(POVERTY = povertyProp) %>%
  rename(POVERTYB = povertyBProp) %>%
  rename(MEDICAID = medicaidProp) %>%
  rename(TANF = tanfProp) %>%
  rename(SNAP = snapProp) %>%
  rename(RENT = rentProp) %>%
  rename(UNINS = uninsProp) %>%
  rename(ASTHMA = asthmaProp) %>%
  rename(OBESITY = obesityProp) %>%
  rename(DENTAL = dentalProp) -> analysis_preSpatial

tractsComplete <- left_join(tracts, analysis_preSpatial, by = "GEOID")

st_write(tractsComplete, here("data", "spatial", "clean", "STL_REDLINING_Analysis.shp"))
```

